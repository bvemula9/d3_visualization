<!DOCTYPE html>
<html>
 <head>
	 <script src="https://d3js.org/d3.v4.min.js"></script>
	 <meta charset="utf-8">
	 <style>
			div.tooltip {
						position: absolute;
						text-align: center;
						width: 150px;
						height: 55px;
						padding: 2px;
						font: 12px sans-serif;
						background: lightsteelblue;
						border: 0px;
						border-radius: 8px;
						pointer-events: none;
						line-height:1.5em;
				}
	 </style>

</head>
<body>
	<p>Source:CFTC(Commodity Futures Trading Commision) that is a independent US agency that provides weekly pretroleum reports<p>
	<p>Please Select the data from the dropdown below<p>
	<svg width="1150" height="300"></svg>
	<chart2 ng-model="data" style="display:block;" id="plot1" class="ng-pristine ng-valid">
	</chart2>
  // dropdown #1 for selecting csv
	<select id="flter" name="flter" onchange="updateData(this.id)" >
		<option value="">select Data</option>
		<option value="final_cftc_f.csv">CFTC_Futures</option>
		<option value="final_cftc_c.csv">CFTC_Futures_options</option>
	</select>
  // dropdown #2 for filtering row
	<select id="flter_col" class="6 columns">
		<option value="">select Row</option>
		<option value="CRUDE OIL, LIGHT SWEET-WTI - ICE FUTURES EUROPE">"CRUDE OIL, LIGHT SWEET-WTI - ICE FUTURES EUROPE"</option>
		<option value="CRUDE OIL, LIGHT SWEET - NEW YORK MERCANTILE EXCHANGE">"CRUDE OIL, LIGHT SWEET - NEW YORK MERCANTILE EXCHANGE"</option>
	</select>
	<script>
    //creating chart1 using svg
		var svg = d3.select("svg"),
		margin = {top: 20, right:100, bottom:50, left:90},
		width = +svg.attr("width") - margin.left -margin.right,
		height = +svg.attr("height") -margin.top -margin.bottom,
		g= svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")");
		var parseTime = d3.timeParse("%y%m%d");
		var parseDate = d3.timeFormat("%Y-%B-%d");

		var line = g.append("g").attr("class", "linegroup");
    // creating chart 2 using svg
		var chart2 = d3.select("chart2")
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		var linet = chart2.append("g").attr("class", "line1group");

    //declaring axis
		var x = d3.scaleTime().rangeRound([0, width-50]);
		var y = d3.scaleLinear().rangeRound([height,0]);
		var y1 = d3.scaleLinear().rangeRound([height,0]);
		var ysp = d3.scaleLinear().rangeRound([height,0]);

    // Creating Lines
		var line1 = d3.line()
			.x(function(d) {return x(d.datetime);})
			.y(function(d) {return y(d.Swap_net);});

		var line2 = d3.line()
			.x(function(d) {return x(d.datetime);})
			.y(function(d) {return y(d.Managed_net);});

		var line3 = d3.line()
			.x(function(d) {return x(d.datetime);})
			.y(function(d) {return y(d.Prod_net);});

		var line4 = d3.line()
			.x(function(d) {return x(d.datetime);})
			.y(function(d) {return y(d.other_net);});

		var line5 = d3.line()
			.x(function(d) {return x(d.datetime);})
			.y(function(d) {return y1(d.Swap_ratio);});

		var line6 = d3.line()
			.x(function(d) {return x(d.datetime);})
			.y(function(d) {return y1(d.Managed_ratio);});

		var line7 = d3.line()
			.x(function(d) {return x(d.datetime);})
			.y(function(d) {return y1(d.Prod_ratio);});

		var line8 = d3.line()
			.x(function(d) {return x(d.datetime);})
			.y(function(d) {return ysp(d.spot_price);});

		function updateData(s){
			var s = document.getElementById(s);
			var filename = s.value;
			console.log(filename);
			var selectVal ={};
			var dataf;
			d3.select('#flter_col').property('value',"");
			d3.csv(filename, function(data) {

			d3.select('#flter_col').on('change',searchnode);


			function searchnode(){
        // Filtering the row based on the dropdown 2 selection
				var value = d3.select(this).property("Market_and_Exchange_Names");
				selectVal = d3.select(this).property('value');
				dataf =data.filter(function(row){
				return row["Market_and_Exchange_Names"] == selectVal;
				});

			dataf.forEach(function(d) {
				d.datetime = parseTime(d.As_of_Date_In_Form_YYMMDD);
				d.parsedate = parseDate(d.datetime);
				d.Open_Interest_All = +d.Open_Interest_All;
				d.Market_and_Exchange_Names = d['Market_and_Exchange_Names'];
				d.Swap_net = +d.Swap_net;
				d.Managed_net = +d.Managed_net;
				d.other_net = +d.other_net;
				d.Prod_net = +d.Prod_net;
				d.spot_price = +d.spot_price;
				d.Managed_ratio = +d.Managed_ratio;
				d.other_ratio = +d.other_ratio;
				d.Prod_ratio = +d.Prod_ratio;
			}, this);


		initAxis();
				function initAxis()
		{
      // defining the axes range
			var yminp = d3.min(dataf, function(d) { return d.Prod_net})
			var ymins = d3.min(dataf, function(d) { return d.Swap_net})
			var yminm = d3.min(dataf, function(d) { return d.Managed_net})
			var ymin = d3.min([yminm,yminp,ymins]);
			var ymaxp = d3.max(dataf, function(d) { return d.Prod_net})
			var ymaxs = d3.max(dataf, function(d) { return d.Swap_net})
			var ymaxm = d3.max(dataf, function(d) { return d.Managed_net})
			var ymax = d3.max([ymaxm,ymaxp,ymaxs]);
			x.domain(d3.extent(dataf, function(d) {return d.datetime;}));
			y.domain([ymin,ymax]);
			var y1minp = d3.min(dataf, function(d) { return d.Prod_ratio})
			var y1minm = d3.min(dataf, function(d) { return d.Managed_ratio})
			var y1min = d3.min([y1minm,y1minp,]);
			var y1maxp = d3.max(dataf, function(d) { return d.Prod_ratio})
			var y1maxm = d3.max(dataf, function(d) { return d.Managed_ratio})
			var y1max = d3.max([y1maxm,y1maxp]);
			y1.domain([y1min,y1max]);
			ysp.domain(d3.extent(dataf, function(d) {return d.spot_price;}));

		}
			var dataNest = d3.nest()
			.key(function(d) {return d.Market_and_Exchange_Names;})
			.entries(dataf);
			if(dataNest.length == 0){

							line.selectAll("path").remove();
							line.selectAll("circle").remove();
							linet.selectAll("path").remove();
							linet.selectAll("circle").remove();

						}
		dataNest.forEach(function(d){
			console.log(d);
        //removing previous x-axis
				g.selectAll("g.xaxis").remove();
        //drawing x-axis
				g.append("g")
  				.attr("class","xaxis")
  				.attr("transform", "translate(0,"+height+")")
  				.call(d3.axisBottom(x))
  				.select(".domain")
  				.append("text")
  				.text("time");
        //Chart1 title
        g.append("text")
          .attr("x", (width / 2))
          .attr("y", 0 - (margin.top / 2))
          .attr("text-anchor", "middle")
          .style("font-size", "14px")
          .style("text-decoration", "underline")
          .text("Net values Comparison");
        //y-axis label
        g.append('text')
          .text('Net Value')
          .attr('text-anchor', 'end')
          .attr("transform", "rotate(-90)")
          .attr('dy', -50)
          .attr('dx', -90)
        //x-axis label
        g.append('text')
          .text("Time -->")
          .attr('text-anchor', 'end')
          .attr('y', height+20)
          .attr('dy', 15)
          .attr('dx', width-90)
        //chart2 title
        chart2.append("text")
          .attr("x", (width / 2))
          .attr("y", 0 - (margin.top / 2))
          .attr("text-anchor", "middle")
          .style("font-size", "14px")
          .style("text-decoration", "underline")
          .text("Ratios Comparison");
        //Y-axis label for chart2
        chart2.append('text')
          .text('Ratios')
          .attr('text-anchor', 'end')
          .attr("transform", "rotate(-90)")
          .attr('dy', -50)
          .attr('dx', -90)
        //X-axis label for chart2
        chart2.append('text')
          .text("Time -->")
          .attr('text-anchor', 'end')
          .attr('y', height+20)
          .attr('dy', 15)
          .attr('dx', width-90)
        //removing old x-axis
				chart2.selectAll("g.xaxis").remove();
        //drawing y-axis fo chart2
				chart2.append("g")
  				.attr("class","xaxis")
  				.attr("transform", "translate(0,"+height+")")
  				.call(d3.axisBottom(x))
  				.select(".domain")
  				.append("text")
  				.text("time");
        //removing old y-axis
				g.selectAll("g.yaxis").remove();
        //drawing y-axis
				g.append("g")
  				.attr("class","yaxis")
  				.call(d3.axisLeft(y))
  				.append("text")
  				.attr("transform", "rotate(-90)")
  				.attr("y", 6)
  				.attr("dy", "0.71em")
  				.attr("text-anchor", "end")
  				.text("Net Values");
        ////removing old y-axis for chart2
				chart2.selectAll("g.yaxis").remove();
        //drawing y-axis for chart2
				chart2.append("g")
          .call(d3.axisLeft(y1))
  				.attr("class","yaxis")
          .append("text")
  				.attr("y", 6)
  				.attr("dy", "0.71em")
  				.attr("text-anchor", "end")
          .attr("transform", "rotate(-90)")
  				.text("Ratios ");
        //removing old y-axis
				chart2.selectAll("g.y-axis").remove();
        //drawing multiple y axis
				chart2.append("g")
  				.call(d3.axisRight(ysp))
  				.attr("class","y-axis")
  				.attr("transform", "translate(" + (width-50) + " ,0)")
  				.style("fill","purple")
  				.append("text")
  				.attr("y", 20)
  				.attr("dy", "1.31em")
  				.attr("text-anchor", "end")
  				.attr("transform", "rotate(-90)")
  				.text("Spot price");
        //removing old lines
				line.selectAll("path").remove();
        //drawing lines
				line.append("path")
  				.attr("class", "line")
  				.datum(dataf)
  				.attr("fill", "none")
  				.attr("stroke", "steelblue")
  				.attr("d",line1);

				console.log(dataf);

				line.append("path")
  				.attr("class", "line")
  				.datum(dataf)
  				.attr("fill", "none")
  				.attr("stroke", "red")
  				.attr("d",line2);

				line.append("path")
  				.attr("class", "line")
  				.datum(dataf)
  				.attr("fill", "none")
  				.attr("stroke", "green")
  				.attr("d",line3);

			// chart 2
				linet.selectAll("path").remove();

				linet.append("path")
  				.attr("class", "line")
  				.datum(dataf)
  				.attr("fill", "none")
  				.attr("stroke", "red")
  				.attr("d",line6);

				linet.append("path")
  				.attr("class", "line")
  				.datum(dataf)
  				.attr("fill", "none")
  				.attr("stroke", "green")
  				.attr("d",line7);

				linet.append("path")
  				.attr("class", "line")
  				.datum(dataf)
  				.attr("fill", "none")
  				.attr("stroke", "purple")
  				.attr("d",line8);



				chart2.exit()
  				.attr("class","exit")
  				.transition(750)
  				.remove();

				var xAxis = d3.axisBottom(x);
				g.selectAll("g.x.axis")
				    .call(xAxis);

				var div = d3.select("body").append("div")
  				.attr("class", "tooltip")
  				.style("opacity", 0);

			//dots and tooltip of svg.
				line.selectAll("circle").remove();
				line.selectAll("dot")
								.data(dataf)
								.enter()
								.append("circle")
								.attr("r",5)
								.attr("cx", function(d){return x(d.datetime);})
								.attr("cy", function(d){return y(d.Prod_net); })
								.attr("fill","green")
								.on("mouseover", function(d){
									 div.transition()
											.duration(200)
											.style("opacity", 1);
									 div.html("Date: "+d.parsedate + "<br/>"  +"Prod_Net: " + d.Prod_net)
											.style("top", (d3.event.pageY-10) + "px").style("left", (d3.event.pageX+10)+"px");
								})
								.on("mouseout", function(d){
									 div.transition()
											.duration(500)
											.style("opacity", 0);
								});
				 line.selectAll("dot")
								.data(dataf)
								.enter()
								.append("circle")
								.attr("r",5)
								.attr("cx", function(d){return x(d.datetime);})
								.attr("cy", function(d){return y(d.Swap_net); })
								.attr("fill","steelblue")
								.on("mouseover", function(d){
									 div.transition()
											.duration(200)
											.style("opacity", 1);
									 div.html("Date: "+d.parsedate + "<br/>"  +"Swap_Net: " + d.Swap_net)
											.style("top", (d3.event.pageY-10) + "px").style("left", (d3.event.pageX+10)+"px");
								})
								.on("mouseout", function(d){
									 div.transition()
											.duration(500)
											.style("opacity", 0);
								});
				 line.selectAll("dot")
								.data(dataf)
								.enter()
								.append("circle")
								.attr("r",5)
								.attr("cx", function(d){return x(d.datetime);})
								.attr("cy", function(d){return y(d.Managed_net); })
								.attr("fill","red")
								.on("mouseover", function(d){
									 div.transition()
											.duration(200)
											.style("opacity", 1);
									 div.html("Date: "+d.parsedate + "<br/>"  +"Managed_Net: " + d.Managed_net)
											.style("top", (d3.event.pageY-10) + "px").style("left", (d3.event.pageX+10)+"px");
								})
								.on("mouseout", function(d){
									 div.transition()
											.duration(500)
											.style("opacity", 0);
								});

				//dots and tooltip of chart2.
				linet.selectAll("circle").remove();
				linet.selectAll("dot")
								.data(dataf)
								.enter()
								.append("circle")
								.attr("r",5)
								.attr("cx", function(d){return x(d.datetime);})
								.attr("cy", function(d){return y1(d.Managed_ratio); })
								.attr("fill","red")
								.on("mouseover", function(d){
									 div.transition()
											.duration(200)
											.style("opacity", 1);
									 div.html("Date: "+d.parsedate + "<br/>"  +"Managed_Ratio: " + d.Managed_ratio)
											.style("top", (d3.event.pageY-10) + "px").style("left", (d3.event.pageX+10)+"px");
								})
								.on("mouseout", function(d){
									 div.transition()
											.duration(500)
											.style("opacity", 0);
								});

				linet.selectAll("dot")
								.data(dataf)
								.enter()
								.append("circle")
								.attr("r",5)
								.attr("cx", function(d){return x(d.datetime);})
								.attr("cy", function(d){return y1(d.Prod_ratio); })
								.attr("fill","green")
								.on("mouseover", function(d){
									 div.transition()
											.duration(200)
											.style("opacity", 1);
									 div.html("Date: "+d.parsedate + "<br/>"  +"Prod_Ratio: "  + d.Prod_ratio)
											.style("top", (d3.event.pageY-10) + "px").style("left", (d3.event.pageX+10)+"px");
								})
								.on("mouseout", function(d){
									 div.transition()
											.duration(500)
											.style("opacity", 0);
								});

				linet.selectAll("dot")
								.data(dataf)
								.enter()
								.append("circle")
								.attr("r",5)
								.attr("cx", function(d){return x(d.datetime);})
								.attr("cy", function(d){return ysp(d.spot_price); })
								.attr("fill","purple")
								.on("mouseover", function(d){
									 div.transition()
											.duration(200)
											.style("opacity", 1);
									 div.html("Date: "+d.parsedate + "<br/>"  +"Spot_Price: "  + d.spot_price)
											.style("top", (d3.event.pageY-10) + "px").style("left", (d3.event.pageX+10)+"px");
								})
								.on("mouseout", function(d){
									 div.transition()
											.duration(500)
											.style("opacity", 0);
								});

		// svg legend

		var legend = d3.select('svg')
							.append("g")
							.attr('class', 'legend')
							.attr('transform', function(d, i) {
									var height = 80;
									var x = width;
									var y = i * height;
									return 'translate(' + x + ',' + y + ')';
							});

		legend.append('rect')
				.attr('width', 10)
				.attr('height', 10)
				.attr("x", 50)
				.attr("y", 10)
				.style('fill', "steelblue")

		legend.append("text")
				.attr("x", 70)
				.attr("z-index", 1)
				.attr("y", 15)
				.attr("dy", "0.32em")
				.text("Swap_net");

		legend.append('rect')
				.attr('width', 10)
				.attr('height', 10)
				.attr("x", 50)
				.attr("y", 30)
				.style('fill', "red")

		legend.append("text")
				.attr("x", 70)
				.attr("z-index", 1)
				.attr("y", 35)
				.attr("dy", "0.32em")
				.text("Managed_net");

		legend.append('rect')
				.attr('width', 10)
				.attr('height', 10)
				.attr("x", 50)
				.attr("y", 50)
				.style('fill', "green")

		legend.append("text")
					.attr("x", 70)
					.attr("z-index", 1)
					.attr("y", 55)
					.attr("dy", "0.32em")
					.text("Prod_net");

				// chart2 legend

		var legend1 = chart2.append("g")
							.attr('class', 'legend')
							.attr('transform', function(d, i) {

									var x = width;
									var y = 100;
									return 'translate(' + x + ',' + y + ')';
							});

		legend1.append('rect')
						.attr('width', 10)
						.attr('height', 10)
						.attr("x", -20)
						.attr("y", 10)
						.style('fill', "red")

		legend1.append("text")
						.attr("x", 0)
						.attr("z-index", 1)
						.attr("y", 15)
						.attr("dy", "0.32em")
						.text("Managed_ratio");

		legend1.append('rect')
						.attr('width', 10)
						.attr('height', 10)
						.attr("x", -20)
						.attr("y", 30)
						.style('fill', "green")

		legend1.append("text")
						.attr("x", 0)
						.attr("z-index", 1)
						.attr("y", 35)
						.attr("dy", "0.32em")
						.text("Prod_ratio");

		legend1.append('rect')
						.attr('width', 10)
						.attr('height', 10)
						.attr("x", -20)
						.attr("y", 50)
						.style('fill', "purple")

		legend1.append("text")
						.attr("x", 0)
						.attr("z-index", 1)
						.attr("y", 55)
						.attr("dy", "0.32em")
						.text("spot_price");

				})}});}

	</script>
</body>
